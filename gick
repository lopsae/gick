#!/bin/bash

read -d '' helpDoc <<"helpDoc"
NAME
    gick -- picks files from git status

SYNOPSIS
    pick [-hxswa] <substring>...

DESCRIPTION
    Using the pick command prints the first matching file that appears in
    git status. By default only the filename is printed.

OPTIONS
    -h  Prints this help output.

    -x  Prints also the status of the matched file. The format remains the
        same used by `git status`.

    -s  Considers only files with any status in stage.

    -w  Considers only files with any status in the workspace.

    -a  Displays all files that match the search.
helpDoc


# Error codes
error_invalidOptions=1
error_noParams=2
error_noMatch=3


# Options values
showStatus='false'
glistOptions=''
pickOptions=''


# Options parsing
while getopts :hxwsa option; do
	case $option in
 		h)
			# Print help
			if [[ -t 0 ]]; then
				echo "$helpDoc" | less
			else
				echo "$helpDoc"
			fi
			exit
			;;
		x)
			# Display status
			showStatus='true'
			;;
		[sw])
			# Pass through to glist
			# Limit to stage or workspace
			glistOptions+=" -$option"
			;;
		[a])
			# Pass through to pick
			pickOptions+=" -$option"
			;;
		?)
			echo "Invalid option: -$OPTARG" >&2
			exit $error_invalidOptions
			;;
	esac
done

shift $(( OPTIND - 1 ));


# Options validation
if [[ $# = 0 ]]; then
	echo 'No parameters given' >&2
	exit $error_noParams
fi


# List of files to consider
fileList=$(glist -c $glistOptions)

# Picking
matches=$(echo "$fileList" | pick $pickOptions -- "$@" 2>/dev/null)
if [[ $? != 0 ]]; then
	echo 'No match found' >&2
	exit $error_noMatch
fi

if [[ $showStatus = 'true' ]]; then
	# TODO doing head just in case this is a double status file
	# remove oooonce glist assures single status for each file
	glist -- "$matches" | head -n 1
else
	echo "$matches"
fi

